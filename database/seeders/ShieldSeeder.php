<?php

declare(strict_types=1);

namespace Database\Seeders;

use BezhanSalleh\FilamentShield\Support\Utils;
use Illuminate\Database\Seeder;
use Spatie\Permission\PermissionRegistrar;

class ShieldSeeder extends Seeder
{
    public static function makeDirectPermissions(string $directPermissions): void
    {
        if (! blank($permissions = json_decode($directPermissions, true))) {
            /** @var Model $permissionModel */
            $permissionModel = Utils::getPermissionModel();

            foreach ($permissions as $permission) {
                if ($permissionModel::whereName($permission)->doesntExist()) {
                    $permissionModel::create([
                        'name' => $permission['name'],
                        'guard_name' => $permission['guard_name'],
                    ]);
                }
            }
        }
    }

    public function run(): void
    {
        app()[PermissionRegistrar::class]->forgetCachedPermissions();

        $rolesWithPermissions = '[{"name":"Admin","guard_name":"web","permissions":["view_announcement","view_any_announcement","create_announcement","update_announcement","restore_announcement","restore_any_announcement","replicate_announcement","reorder_announcement","delete_announcement","delete_any_announcement","force_delete_announcement","force_delete_any_announcement","view_apilog","view_any_apilog","create_apilog","update_apilog","restore_apilog","restore_any_apilog","replicate_apilog","reorder_apilog","delete_apilog","delete_any_apilog","force_delete_apilog","force_delete_any_apilog","view_assignmentrecord","view_any_assignmentrecord","create_assignmentrecord","update_assignmentrecord","restore_assignmentrecord","restore_any_assignmentrecord","replicate_assignmentrecord","reorder_assignmentrecord","delete_assignmentrecord","delete_any_assignmentrecord","force_delete_assignmentrecord","force_delete_any_assignmentrecord","view_attachment","view_any_attachment","create_attachment","update_attachment","restore_attachment","restore_any_attachment","replicate_attachment","reorder_attachment","delete_attachment","delete_any_attachment","force_delete_attachment","force_delete_any_attachment","view_award","view_any_award","create_award","update_award","restore_award","restore_any_award","replicate_award","reorder_award","delete_award","delete_any_award","force_delete_award","force_delete_any_award","view_awardrecord","view_any_awardrecord","create_awardrecord","update_awardrecord","restore_awardrecord","restore_any_awardrecord","replicate_awardrecord","reorder_awardrecord","delete_awardrecord","delete_any_awardrecord","force_delete_awardrecord","force_delete_any_awardrecord","view_calendar","view_any_calendar","create_calendar","update_calendar","restore_calendar","restore_any_calendar","replicate_calendar","reorder_calendar","delete_calendar","delete_any_calendar","force_delete_calendar","force_delete_any_calendar","view_combatrecord","view_any_combatrecord","create_combatrecord","update_combatrecord","restore_combatrecord","restore_any_combatrecord","replicate_combatrecord","reorder_combatrecord","delete_combatrecord","delete_any_combatrecord","force_delete_combatrecord","force_delete_any_combatrecord","view_comment","view_any_comment","create_comment","update_comment","restore_comment","restore_any_comment","replicate_comment","reorder_comment","delete_comment","delete_any_comment","force_delete_comment","force_delete_any_comment","view_document","view_any_document","create_document","update_document","restore_document","restore_any_document","replicate_document","reorder_document","delete_document","delete_any_document","force_delete_document","force_delete_any_document","view_event","view_any_event","create_event","update_event","restore_event","restore_any_event","replicate_event","reorder_event","delete_event","delete_any_event","force_delete_event","force_delete_any_event","view_field","view_any_field","create_field","update_field","restore_field","restore_any_field","replicate_field","reorder_field","delete_field","delete_any_field","force_delete_field","force_delete_any_field","view_form","view_any_form","create_form","update_form","restore_form","restore_any_form","replicate_form","reorder_form","delete_form","delete_any_form","force_delete_form","force_delete_any_form","view_group","view_any_group","create_group","update_group","restore_group","restore_any_group","replicate_group","reorder_group","delete_group","delete_any_group","force_delete_group","force_delete_any_group","view_image","view_any_image","create_image","update_image","restore_image","restore_any_image","replicate_image","reorder_image","delete_image","delete_any_image","force_delete_image","force_delete_any_image","view_passportclient","view_any_passportclient","create_passportclient","update_passportclient","restore_passportclient","restore_any_passportclient","replicate_passportclient","reorder_passportclient","delete_passportclient","delete_any_passportclient","force_delete_passportclient","force_delete_any_passportclient","view_passporttoken","view_any_passporttoken","create_passporttoken","update_passporttoken","restore_passporttoken","restore_any_passporttoken","replicate_passporttoken","reorder_passporttoken","delete_passporttoken","delete_any_passporttoken","force_delete_passporttoken","force_delete_any_passporttoken","view_position","view_any_position","create_position","update_position","restore_position","restore_any_position","replicate_position","reorder_position","delete_position","delete_any_position","force_delete_position","force_delete_any_position","view_qualification","view_any_qualification","create_qualification","update_qualification","restore_qualification","restore_any_qualification","replicate_qualification","reorder_qualification","delete_qualification","delete_any_qualification","force_delete_qualification","force_delete_any_qualification","view_qualificationrecord","view_any_qualificationrecord","create_qualificationrecord","update_qualificationrecord","restore_qualificationrecord","restore_any_qualificationrecord","replicate_qualificationrecord","reorder_qualificationrecord","delete_qualificationrecord","delete_any_qualificationrecord","force_delete_qualificationrecord","force_delete_any_qualificationrecord","view_rank","view_any_rank","create_rank","update_rank","restore_rank","restore_any_rank","replicate_rank","reorder_rank","delete_rank","delete_any_rank","force_delete_rank","force_delete_any_rank","view_rankrecord","view_any_rankrecord","create_rankrecord","update_rankrecord","restore_rankrecord","restore_any_rankrecord","replicate_rankrecord","reorder_rankrecord","delete_rankrecord","delete_any_rankrecord","force_delete_rankrecord","force_delete_any_rankrecord","view_role","view_any_role","create_role","update_role","delete_role","delete_any_role","view_servicerecord","view_any_servicerecord","create_servicerecord","update_servicerecord","restore_servicerecord","restore_any_servicerecord","replicate_servicerecord","reorder_servicerecord","delete_servicerecord","delete_any_servicerecord","force_delete_servicerecord","force_delete_any_servicerecord","view_specialty","view_any_specialty","create_specialty","update_specialty","restore_specialty","restore_any_specialty","replicate_specialty","reorder_specialty","delete_specialty","delete_any_specialty","force_delete_specialty","force_delete_any_specialty","view_status","view_any_status","create_status","update_status","restore_status","restore_any_status","replicate_status","reorder_status","delete_status","delete_any_status","force_delete_status","force_delete_any_status","view_submission","view_any_submission","create_submission","update_submission","restore_submission","restore_any_submission","replicate_submission","reorder_submission","delete_submission","delete_any_submission","force_delete_submission","force_delete_any_submission","view_task","view_any_task","create_task","update_task","restore_task","restore_any_task","replicate_task","reorder_task","delete_task","delete_any_task","force_delete_task","force_delete_any_task","view_unit","view_any_unit","create_unit","update_unit","restore_unit","restore_any_unit","replicate_unit","reorder_unit","delete_unit","delete_any_unit","force_delete_unit","force_delete_any_unit","view_user","view_any_user","create_user","update_user","restore_user","restore_any_user","replicate_user","reorder_user","delete_user","delete_any_user","force_delete_user","force_delete_any_user","view_webhook","view_any_webhook","create_webhook","update_webhook","restore_webhook","restore_any_webhook","replicate_webhook","reorder_webhook","delete_webhook","delete_any_webhook","force_delete_webhook","force_delete_any_webhook","view_webhooklog","view_any_webhooklog","create_webhooklog","update_webhooklog","restore_webhooklog","restore_any_webhooklog","replicate_webhooklog","reorder_webhooklog","delete_webhooklog","delete_any_webhooklog","force_delete_webhooklog","force_delete_any_webhooklog","page_Calendar","page_Roster","page_PublicListForms","page_Logs","page_Integration","page_Organization","page_Permission","page_Registration","widget_OrganizationInfoWidget","widget_UsersOverview","widget_RecentAnnouncements","widget_CalendarWidget"]},{"name":"User","guard_name":"web","permissions":["create_submission","view_user","view_any_user"]}]';
        $directPermissions = '[{"name":"view:announcement","guard_name":"web"},{"name":"create:announcement","guard_name":"web"},{"name":"update:announcement","guard_name":"web"},{"name":"delete:announcement","guard_name":"web"},{"name":"view:award","guard_name":"web"},{"name":"create:award","guard_name":"web"},{"name":"update:award","guard_name":"web"},{"name":"delete:award","guard_name":"web"},{"name":"view:calendar","guard_name":"web"},{"name":"create:calendar","guard_name":"web"},{"name":"update:calendar","guard_name":"web"},{"name":"delete:calendar","guard_name":"web"},{"name":"view:category","guard_name":"web"},{"name":"create:category","guard_name":"web"},{"name":"update:category","guard_name":"web"},{"name":"delete:category","guard_name":"web"},{"name":"view:document","guard_name":"web"},{"name":"create:document","guard_name":"web"},{"name":"update:document","guard_name":"web"},{"name":"delete:document","guard_name":"web"},{"name":"view:event","guard_name":"web"},{"name":"create:event","guard_name":"web"},{"name":"update:event","guard_name":"web"},{"name":"delete:event","guard_name":"web"},{"name":"view:group","guard_name":"web"},{"name":"create:group","guard_name":"web"},{"name":"update:group","guard_name":"web"},{"name":"delete:group","guard_name":"web"},{"name":"view:mail","guard_name":"web"},{"name":"create:mail","guard_name":"web"},{"name":"update:mail","guard_name":"web"},{"name":"delete:mail","guard_name":"web"},{"name":"view:position","guard_name":"web"},{"name":"create:position","guard_name":"web"},{"name":"update:position","guard_name":"web"},{"name":"delete:position","guard_name":"web"},{"name":"view:qualification","guard_name":"web"},{"name":"create:qualification","guard_name":"web"},{"name":"update:qualification","guard_name":"web"},{"name":"delete:qualification","guard_name":"web"},{"name":"view:rank","guard_name":"web"},{"name":"create:rank","guard_name":"web"},{"name":"update:rank","guard_name":"web"},{"name":"delete:rank","guard_name":"web"},{"name":"view:specialty","guard_name":"web"},{"name":"create:specialty","guard_name":"web"},{"name":"update:specialty","guard_name":"web"},{"name":"delete:specialty","guard_name":"web"},{"name":"view:status","guard_name":"web"},{"name":"create:status","guard_name":"web"},{"name":"update:status","guard_name":"web"},{"name":"delete:status","guard_name":"web"},{"name":"view:unit","guard_name":"web"},{"name":"create:unit","guard_name":"web"},{"name":"update:unit","guard_name":"web"},{"name":"delete:unit","guard_name":"web"},{"name":"view:form","guard_name":"web"},{"name":"create:form","guard_name":"web"},{"name":"update:form","guard_name":"web"},{"name":"delete:form","guard_name":"web"},{"name":"view:field","guard_name":"web"},{"name":"create:field","guard_name":"web"},{"name":"update:field","guard_name":"web"},{"name":"delete:field","guard_name":"web"},{"name":"view:submission","guard_name":"web"},{"name":"create:submission","guard_name":"web"},{"name":"update:submission","guard_name":"web"},{"name":"delete:submission","guard_name":"web"},{"name":"view:user","guard_name":"web"},{"name":"create:user","guard_name":"web"},{"name":"update:user","guard_name":"web"},{"name":"note:user","guard_name":"web"},{"name":"delete:user","guard_name":"web"},{"name":"impersonate:user","guard_name":"web"},{"name":"view:permission","guard_name":"web"},{"name":"create:permission","guard_name":"web"},{"name":"update:permission","guard_name":"web"},{"name":"delete:permission","guard_name":"web"},{"name":"view:role","guard_name":"web"},{"name":"create:role","guard_name":"web"},{"name":"update:role","guard_name":"web"},{"name":"delete:role","guard_name":"web"},{"name":"view:awardrecord","guard_name":"web"},{"name":"create:awardrecord","guard_name":"web"},{"name":"update:awardrecord","guard_name":"web"},{"name":"delete:awardrecord","guard_name":"web"},{"name":"view:assignmentrecord","guard_name":"web"},{"name":"create:assignmentrecord","guard_name":"web"},{"name":"update:assignmentrecord","guard_name":"web"},{"name":"delete:assignmentrecord","guard_name":"web"},{"name":"view:combatrecord","guard_name":"web"},{"name":"create:combatrecord","guard_name":"web"},{"name":"update:combatrecord","guard_name":"web"},{"name":"delete:combatrecord","guard_name":"web"},{"name":"view:qualificationrecord","guard_name":"web"},{"name":"create:qualificationrecord","guard_name":"web"},{"name":"update:qualificationrecord","guard_name":"web"},{"name":"delete:qualificationrecord","guard_name":"web"},{"name":"view:rankrecord","guard_name":"web"},{"name":"create:rankrecord","guard_name":"web"},{"name":"update:rankrecord","guard_name":"web"},{"name":"delete:rankrecord","guard_name":"web"},{"name":"view:servicerecord","guard_name":"web"},{"name":"create:servicerecord","guard_name":"web"},{"name":"update:servicerecord","guard_name":"web"},{"name":"delete:servicerecord","guard_name":"web"},{"name":"view:statusrecord","guard_name":"web"},{"name":"create:statusrecord","guard_name":"web"},{"name":"update:statusrecord","guard_name":"web"},{"name":"delete:statusrecord","guard_name":"web"},{"name":"view:task","guard_name":"web"},{"name":"create:task","guard_name":"web"},{"name":"update:task","guard_name":"web"},{"name":"delete:task","guard_name":"web"},{"name":"view:log","guard_name":"web"},{"name":"create:comment","guard_name":"web"},{"name":"create:attachment","guard_name":"web"},{"name":"create:image","guard_name":"web"},{"name":"manage:billing","guard_name":"web"},{"name":"manage:api","guard_name":"web"},{"name":"manage:webhook","guard_name":"web"},{"name":"manage:newsfeed","guard_name":"web"}]';

        static::makeRolesWithPermissions($rolesWithPermissions);
        static::makeDirectPermissions($directPermissions);

        $this->command->info('Shield Seeding Completed.');
    }

    protected static function makeRolesWithPermissions(string $rolesWithPermissions): void
    {
        if (! blank($rolePlusPermissions = json_decode($rolesWithPermissions, true))) {
            /** @var Model $roleModel */
            $roleModel = Utils::getRoleModel();
            /** @var Model $permissionModel */
            $permissionModel = Utils::getPermissionModel();

            foreach ($rolePlusPermissions as $rolePlusPermission) {
                $role = $roleModel::firstOrCreate([
                    'name' => $rolePlusPermission['name'],
                    'guard_name' => $rolePlusPermission['guard_name'],
                ]);

                if (! blank($rolePlusPermission['permissions'])) {
                    $permissionModels = collect($rolePlusPermission['permissions'])
                        ->map(fn ($permission) => $permissionModel::firstOrCreate([
                            'name' => $permission,
                            'guard_name' => $rolePlusPermission['guard_name'],
                        ]))
                        ->all();

                    $role->syncPermissions($permissionModels);
                }
            }
        }
    }
}
